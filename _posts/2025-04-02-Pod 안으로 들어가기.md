---
layout: post
category: k8s
---
##  ğŸŒŠ Under the Pod ğŸŒŠ
### 1ï¸âƒ£ Pod ë‚´ë¶€ì—ì„œ kubectl ì‚¬ìš©í•˜ê¸°


#### 1.1 Pod ìƒì„± ë° ì˜¤ë¥˜ í™•ì¸
ë¨¼ì € íŒŒë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. í˜„ì¬ ìƒì„±ëœ íŒŒë“œì— ëŒ€í•´ 

ë¨¼ì € ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ kubectl ì´ ì„¤ì¹˜ë˜ì–´ìˆëŠ” ìƒˆë¡œìš´ íŒŒë“œë¥¼ ìƒì„±í•œ í›„ íŒŒë“œì— ì ‘ì†í•©ë‹ˆë‹¤. 

```shell
kubectl run kubectl --image bitnami/kubectl:latest --command -- sleep infinity
kubectl exec -it kubectl -- /bin/bash
```

íŒŒë“œ ë‚´ë¶€ì—ì„œ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰ì‹œí‚¬ ê²½ìš° ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ ë©”ì„¸ì§€ë¥¼ í™•ì¸ í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```shell
kubectl get pod
```
![week401](../images/week401.png)
<!--
í•´ë‹¹ ì—ëŸ¬ë©”ì„¸ì§€ì˜ ê²½ìš° í•´ë‹¹ íŒŒë“œê°€ ìƒì„±ë˜ì–´ìˆëŠ” Default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ Default Service Account ë¥¼ ì‚¬ìš©í•˜ë©°, í•´ë‹¹ Service Accountì— Kubectl ëª…ë ¹ì„ í†µí•´ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ íŒŒë“œë¥¼ ì¡°íšŒí•  ê¶Œí•œì´ ì—†ë‹¤ëŠ” ì˜¤ë¥˜ ì…ë‹ˆë‹¤.

ê·¸ë ‡ê¸°ì— í•´ë‹¹ íŒŒë“œì—ì„œ ì‚¬ìš©ì¤‘ì¸ Default Service Accountì— ì´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ 
-->
 
#### 1.2 role & role binding ìƒì„±

ë¨¼ì € kubectl ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì´ ëª…ì‹œë˜ì–´ìˆëŠ” role ì„ ìƒì„±í•©ë‹ˆë‹¤. ì•„ë˜ yaml íŒŒì¼ì„ ì ìš©í•˜ì—¬, ì´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: kubectl-readonly
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["pods", "services", "configmaps"]
    verbs: ["get", "list", "watch"]
```

ìƒì„±í•œ roleì„ rolebinding ì„ í†µí•´ í˜„ì¬ ìƒì„±ë˜ì–´ìˆëŠ” service account ì— ì ìš© í•´ì¤ë‹ˆë‹¤.

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubectl-readonly-binding
  namespace: default
subjects:
  - kind: ServiceAccount
    name: default
    namespace: default
roleRef:
  kind: Role
  name: kubectl-readonly
  apiGroup: rbac.authorization.k8s.io
```

ì´ë¥¼ ëª¨ë‘ ìƒì„±í•œ í›„ ë‹¤ì‹œ ìƒì„±í•œ íŒŒë“œì— ì ‘ê·¼ í•˜ì—¬ `kubectl get pod` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš© í•˜ë©´ ì •ìƒì ìœ¼ë¡œ í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ í´ëŸ¬ìŠ¤í„°ì˜ íŒŒë“œ ëª©ë¡ì„ ì ‘ê·¼ í•©ë‹ˆë‹¤.

<hr/>


### 2ï¸âƒ£ Pod ë‚´ë¶€ì—ì„œ AWS CLI ì‚¬ìš©í•˜ê¸°

#### 2.1 Pod ìƒì„± ë° ì˜¤ë¥˜ í™•ì¸

ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ AWS CLI ê°€ ì„¤ì¹˜ë˜ì–´ìˆëŠ” íŒŒë“œë¥¼ ìƒì„± í›„ í•´ë‹¹ íŒŒë“œë¡œ /bin/bashë¥¼ ì‚¬ìš©í•˜ì—¬ ì ‘ê·¼í•©ë‹ˆë‹¤.

```bash
kubectl run awscli --image amazon/aws-cli:latest --command -- sleep infinity
kubectl exec -it awscli -- /bin/bash
```
íŒŒë“œì— ì ‘ê·¼ í•˜ì—¬ `aws s3 ls` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤ë©´, ì•„ë˜ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒë©ë‹ˆë‹¤.

![week402](../images/week402.png)

#### 2.2 IAM Role ìƒì„± ë° Service Account ìƒì„±

AWS CLI ë¥¼ íŒŒë“œ ë‚´ì—ì„œ ì‚¬ìš© í•˜ê¸° ìœ„í•´ì„ , íŒŒë“œì— ì—°ê²°ë˜ì–´ìˆëŠ” ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸, í˜¹ì€ ì›Œì»¤ ë…¸ë“œì—ì„œ ì‚¬ìš©ë˜ëŠ” IAM ì—­í• ì— AWS CLI ì—ì„œ ìš”êµ¬ë˜ëŠ” ê¶Œí•œì„ ìœ„ì„í•˜ëŠ” ì—­í• ì´ ë§¤í•‘ ë˜ì–´ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
ë¨¼ì € AWS CLI ë¥¼ í†µí•´ ë¡œì»¬ì—ì„œ IAM Role ìƒì„±ì„ ì§„í–‰ í•´ë³´ê² ìŠµë‹ˆë‹¤.

```bash
cat <<EOF > s3-list-policy.json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:ListAllMyBuckets"
            ],
            "Resource": "*"
        }
    ]
}
EOF

# iam policy ìƒì„±
aws iam create-policy \
  --policy-name s3-list-only-policy \
  --policy-document file://s3-list-policy.json

# ìƒì„±í•œ iam policy ë¥¼ í†µí•´ service account ìƒì„±
eksctl create iamserviceaccount \
    --cluster codns-cluster \
    --namespace default \
    --name week4-sa \
    --attach-policy-arn arn:aws:iam::<aws-account>:policy/s3-list-only-policy \    
    --approve 
```

ê¸°ì¡´ì— ìƒì„±í•˜ì˜€ë˜ íŒŒë“œ ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, podë¥¼ êµ¬ì„±í•˜ëŠ” yaml íŒŒì¼ì„ ì‘ì„±í•©ë‹ˆë‹¤.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: awscli
spec:
  automountServiceAccountToken: true
  serviceAccountName: week4-sa
  containers:
  - command:
    - sleep
    - infinity
    image: amazon/aws-cli:latest
    name: awscli
```

ìœ„ yaml íŒŒì¼ì„ `kubectl apply -f <í•´ë‹¹ íŒŒì¼ ìœ„ì¹˜>` ë¥¼ í†µí•´ ì‹¤í–‰ ì‹œí‚¨ í›„ íŒŒë“œ ë‚´ë¶€ì— ì ‘ê·¼í•˜ì—¬ `aws s3 ls` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

### 3ï¸âƒ£ Pod ë‚´ë¶€ì—ì„œ Cross Account ì‚¬ìš©í•˜ì—¬ íƒ€ ê³„ì •ì˜ ë¦¬ì†ŒìŠ¤ ì ‘ê·¼í•˜ê¸°

#### 3.1 ë¬¸ì œìƒí™© í™•ì¸
ìœ„ì—ì„œ ì—°ê²° ìƒì„±í•´ë‘ì—ˆë˜ `aws-cli` íŒŒë“œì—ì„œ ë‹¤ë¥¸ AWSê³„ì •ì— ìœ„ì¹˜í•˜ê³  ìˆëŠ” S3 ë²„í‚·ì„ ì¡°íšŒ í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

ì•„ë¬´ëŸ° ì„¤ì • ì—†ì´ ë‹¤ë¥¸ íŒŒë“œì— ì ‘ê·¼ í•˜ë ¤ê³  í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤. 

```bash
bash-4.2# aws s3api get-object --bucket <bucket name> --key <file location> answer.txt 

An error occurred (AccessDenied) when calling the GetObject operation: Access Denied
```


ë¨¼ì € ëŒ€ìƒ ê³„ì •ì— ì•„ë˜ì™€ ê°™ì€ ì‘ì—…ì´ ì´ë£¨ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤. 
- ì ‘ê·¼í•˜ë ¤ëŠ” ëŒ€ìƒ ê³„ì •ì˜ IAM Role ì‹ ë¢°ê´€ê³„ ì •ì±…ì´ í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ AWS ê³„ì •ì— ëŒ€í•´ assume role ì‘ì—…ì„ ì‹ ë¢°
- ëŒ€ìƒ ê³„ì •ì˜ IAM Roleì´ S3 ë²„í‚·ì„ ì¡°íšŒí•˜ê³  ë‚´ë¶€ íŒŒì¼ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ ë¶€ì—¬

ìœ„ ì‘ì—…ì´ ì´ë£¨ì–´ì ¸ìˆë‹¤ëŠ” ì „ì œí•˜ì— ì§„í–‰ í•˜ê² ìŠµë‹ˆë‹¤.
ë˜í•œ Pod ë‚´ë¶€ì—ì„œ `aws configure`,`aws-cli profile` ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì´ë¥¼ ì§„í–‰ í•´ì•¼ í•˜ê¸°ì—, AWS Boto3ë¥¼ í™œìš©í•˜ì—¬ í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.


#### 3.2 IAM ì •ì±… ì¶”ê°€, Python íŒŒì¼ ì‹¤í–‰

Service Account ê³„ì •ì— ì—°ê²°ë˜ì–´ìˆëŠ” IAM Roleì— assume role ê¶Œí•œì„ ì¶”ê°€ í•©ë‹ˆë‹¤.
ì´ì „ ë‹¨ê³„ì—ì„œ ìƒì„±í•´ë‘” Service Accountì˜ IAM Roleì— ì •ì±…ì„ ìˆ˜ì • í˜¹ì€ ìƒì„±í•˜ì—¬ ì•„ë˜ ì¸ë¼ì¸ IAM ê¶Œí•œì„ ì¶”ê°€í•©ë‹ˆë‹¤. 

```JSON
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "Statement1",
            "Effect": "Allow",
            "Action": [
                "sts:AssumeRole"
            ],
            "Resource": [
                "*"
            ]
        }
    ]
}
```


ì´í›„ ì•„ë˜ ë§í¬ì˜ boto3 ì½”ë“œë¥¼ Pod ë‚´ë¶€ì—ì„œ vi ëª…ë ¹ì–´ë¥¼ í†µí•´ ìƒì„±í•©ë‹ˆë‹¤.

https://github.com/coodns/enhancement/blob/master/it_is_seaman_not_seman/k8s/week4/main.py

ì´í›„ í•´ë‹¹ íŒŒì´ì¬ íŒŒì¼ì„ ì‹¤í–‰ì‹œí‚¤ê¸° ìœ„í•œ python3 ì™€ boto3ë¥¼ ë‹¤ìš´ ë°›ê³  ì´ë¥¼ ì‹¤í–‰ ì‹œí‚µë‹ˆë‹¤.
```bash
yum install -y python3
pip3 install boto3
```
í•´ë‹¹ íŒŒì´ì¬ íŒŒì¼ì„ ì‹¤í–‰ì‹œí‚¬ ê²½ìš°, ì„ì˜ë¡œ ë„£ì–´ë‘ì—ˆë˜, S3 ë²„í‚· ë‚´ íŒŒì¼ì„ ì½ê³  í„°ë¯¸ë„ì— ì¶œë ¥í•´ì¤ë‹ˆë‹¤.

![week4045](../images/week4045.png)

ìœ„ ê³¼ì •ì„ ìš”ì•½í•˜ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

![week403.jpeg](../images/week403.jpeg)


### 4ï¸âƒ£ Pod Identity Agent ì‚¬ìš©í•˜ê¸°

ì–´ë–»ê²Œ í•´ì•¼í•˜ëŠ”ì§€, Console í™”ë©´ ìº¡ì²˜ í•´ì„œ ì§„í–‰ 

í•„ìš”í•œ IAM Role ê¶Œí•œ + Service Account Dummy ì‚¬ìš© í•˜ê³ 

